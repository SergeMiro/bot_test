
// 387442030 - My ID
// 1712121543 - ID Serge Miro

/////////////////////////////////////////////////////////////////////////////////

const TelegramBot = require('node-telegram-bot-api');

const token = "6522058351:AAFbPf4B8MgNVMPvkN6tNDYKk_zYy6se2Cg";
const adminChatId = "387442030";

const bot = new TelegramBot(token, { polling: true });
let forwardingSessions = {};
// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏
let applicationStatus = {};


///////////////////////////////////////////////////////////////////////////////////
////////////////// –§–£–ù–ö–¶–ò–Ø –ò –î–†–£–ì–ò–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –î–õ–Ø –ö–û–ú–ê–ù–î /////////////////////////
///////////////////////////////////////////////////////////////////////////////////

function toMenu() { //—Ñ—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é
	return {
		reply_markup: {
			keyboard: [
				[{ text: '–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É üìÉ' }],
				[{ text: '–ù–∞—à –∫–∞–Ω–∞–ª üì£' }],
				[{ text: '–û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã (FAQ) üìñ' }],
				[{ text: '–°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏ üì±' }]
			],
			resize_keyboard: true,
			one_time_keyboard: false
		}
	};
}

function toFaq() {
	// –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç FAQ
	const text = '–£ –≤–∞—Å —Å–ª–æ–∂–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã ? üòâ –°–∫–∞—á–∞–π—Ç–µ –Ω–∞—à FAQ [‚¨áÔ∏è](https://www.france-experience.fr/files/FAQ_France-Experience.pdf)';
	return {
	  text: text,
	  parse_mode: 'Markdown'
	};
 }

// bot.sendMessage(chatId, '–ö–æ–º–∞–Ω–¥–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞ ü§î, –±—É–¥—å—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–µ–µ.');

///////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////

bot.on('message', (msg) => {
	const chatId = msg.chat.id;
	const fromId = msg.from.id.toString();

	// –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —è–≤–ª—è–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–æ–π '/start'
	if (msg.text && msg.text.toLowerCase() === '/start') {
		if (fromId === adminChatId) {
			 bot.sendMessage(chatId, '–í—ã —è–≤–ª—è–µ—Ç–µ—Å—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –¥–∞–Ω–Ω–æ–≥–æ —á–∞—Ç-–±–æ—Ç–∞. –í–∞–º –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è üòâ');
		} else {
			 bot.sendMessage(chatId, '–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω—É –∏–∑ –æ–ø—Ü–∏–π:', toMenu());
		}
	} else if (msg.text === '–°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏ üì±') {
		 // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª –æ–ø—Ü–∏—é —Å–≤—è–∑–∏
		 bot.sendMessage(chatId, '–í—ã —É–∂–µ –∏–∑—É—á–∏–ª–∏ –Ω–∞—à FAQ? –í –Ω—ë–º –≤—ã –Ω–∞–π–¥–µ—Ç–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –º–Ω–æ–≥–∏–µ –≤–æ–ø—Ä–æ—Å—ã.', {
			  parse_mode: 'Markdown',
			  reply_markup: {
					keyboard: [
						 [{ text: '–ù–∞–ø–∏—Å–∞—Ç—å –Ω–∞–º' }],
						 [{ text: '–ù–∞–∑–∞–¥' }]
					],
					resize_keyboard: true,
					one_time_keyboard: true
			  }
		 });
	} else if (msg.text === '–ù–∞–ø–∏—Å–∞—Ç—å –Ω–∞–º') {
		 // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –Ω–∞–ø–∏—Å–∞—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
		 forwardingSessions[chatId] = adminChatId;
		 bot.sendMessage(chatId, '–ù–∞—à –æ–ø–µ—Ä–∞—Ç–æ—Ä –æ—Ç–≤–µ—Ç–∏—Ç –Ω–∞ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å.', {
			  reply_markup: {
					keyboard: [[{ text: '–ü–æ–∫–∏–Ω—É—Ç—å —á–∞—Ç' }]],
					resize_keyboard: true,
					one_time_keyboard: true,
			  }
		 });
	} else if (msg.text === '–ü–æ–∫–∏–Ω—É—Ç—å —á–∞—Ç') {
		// –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª –ø–æ–∫–∏–Ω—É—Ç—å —á–∞—Ç
		let userName = msg.from.username || `${msg.from.first_name} ${msg.from.last_name || ''}`.trim();
		bot.sendMessage(adminChatId, `${userName} –ø–æ–∫–∏–Ω—É–ª(a) —á–∞—Ç`, {
			 reply_markup: {
				  inline_keyboard: [
						[{ text: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–∞—Ç üîÑ', callback_data: `restore_${chatId}` }]
				  ]
			 }
		});
		delete forwardingSessions[chatId];
		bot.sendMessage(chatId, '–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ —á–∞—Ç.', toMenu());
	} else if (forwardingSessions[adminChatId] && fromId === adminChatId) {
		 // –ï—Å–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
		 const userChatId = forwardingSessions[adminChatId];
		 bot.sendMessage(userChatId, msg.text);
		 // –£–¥–∞–ª–∏—Ç—å —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–æ–∫—É, –µ—Å–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π
		 // delete forwardingSessions[adminChatId];
	} else if (forwardingSessions[chatId] && fromId !== adminChatId) {
		 // –ï—Å–ª–∏ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
		 let userName = msg.from.username || `${msg.from.first_name} ${msg.from.last_name || ''}`.trim();
		 bot.sendMessage(adminChatId, `${userName}:\n${msg.text}`, {
			  reply_markup: {
					inline_keyboard: [[{ text: '–û—Ç–≤–µ—Ç–∏—Ç—å ‚û°Ô∏è', callback_data: `reply_${chatId}` }]]
			  }
		 });
	} else {
		 // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
		 handleRegularMessages(msg, chatId);
	}
});

//////////////////////////////////////////////////////////////////////////////////////////////

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
function handleRegularMessages(msg, chatId) {
	let text = msg.text;

	// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã "–ù–∞–∑–∞–¥"
	if (text === '–ù–∞–∑–∞–¥') {
		// –°–±—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∞—á–∏ –∑–∞—è–≤–∫–∏, –µ—Å–ª–∏ –æ–Ω –∞–∫—Ç–∏–≤–µ–Ω
		if (applicationStatus[chatId]) {
			applicationStatus[chatId] = null;
		}

		// –û—á–∏—Å—Ç–∫–∞ —Å–µ—Å—Å–∏–∏ –ø–µ—Ä–µ—Å—ã–ª–∫–∏, –µ—Å–ª–∏ –æ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞
		if (forwardingSessions[chatId]) {
			delete forwardingSessions[chatId];
		}

		// –í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É –º–µ–Ω—é
		bot.sendMessage(chatId, '–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω—É –∏–∑ –æ–ø—Ü–∏–π:', toMenu());
		return;
	}

	// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –ø–æ–¥–∞—á–∏ –∑–∞—è–≤–∫–∏
	if (applicationStatus[chatId] === 'awaiting_application') {
		// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –∑–∞—è–≤–∫–∏
		bot.sendMessage(chatId, '–í–∞—à–∞ –∑–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! France Experience —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –æ—á–µ–Ω—å —Å–∫–æ—Ä–æ.');
		bot.sendMessage(adminChatId, `–ó–ê–Ø–í–ö–ê –æ—Ç ${msg.from.username || msg.from.first_name}: \n\n${text}`, {
			reply_markup: {
				inline_keyboard: [
					[{ text: '–û—Ç–≤–µ—Ç–∏—Ç—å ‚û°Ô∏è', callback_data: `reply_${chatId}` }]
				]
			}
		});
		applicationStatus[chatId] = null;
		return;
	}

	// if (text === '–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É üìÉ') {
	// 	applicationStatus[chatId] = 'awaiting_application';
	// 	let applicationInstructions = `–û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–∞–º –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –∏ –º—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.\n\n` +
	// 		`_–í–∞—à–µ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—è :_\n` +
	// 		`_–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è :_\n` +
	// 		`_–°—Ç—Ä–∞–Ω–∞ :_\n` +
	// 		`_–ì–æ—Ä–æ–¥ :_\n` +
	// 		`_–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–≤–æ–ø—Ä–æ—Å) :_`;
	// 	const options = {
	// 		parse_mode: 'Markdown',
	// 		reply_markup: {
	// 			keyboard: [
	// 				[{ text: '–ù–∞–∑–∞–¥' }]
	// 			],
	// 			resize_keyboard: true,
	// 			one_time_keyboard: false
	// 		}
	// 	};
	// 	bot.sendMessage(chatId, applicationInstructions, options);
	// 	return;
	// }

	if (text === '–ù–∞—à –∫–∞–Ω–∞–ª üì£') {
		text = '–ü–æ–¥–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å –Ω–∞ –Ω–∞—à –∫–∞–Ω–∞–ª! [–¢–∞–º –º–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–≥–æ:](https://t.me/frexperience)';
		bot.sendMessage(chatId, text, { parse_mode: 'Markdown' });
		return;
	}
	if (text === '–û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã (FAQ) üìñ') {
		const faqMessage = toFaq();
		bot.sendMessage(chatId, faqMessage.text, { parse_mode: faqMessage.parse_mode });
	 }

	// bot.sendMessage(chatId, '–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω—É –∏–∑ –æ–ø—Ü–∏–π:', toMenu());



	// –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É –º–µ–Ω—é
	// bot.sendMessage(chatId, '–ö–æ–º–∞–Ω–¥–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞ ü§î, –±—É–¥—å—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–µ–µ.');
}



//////////////////////////////////////////////////////////////////////////////////////////////
bot.on('callback_query', (callbackQuery) => {
	const adminId = callbackQuery.from.id.toString();
	const data = callbackQuery.data;
	const chatId = callbackQuery.message.chat.id;

	if (data.startsWith('reply_')) {
		 if (adminId === adminChatId) {
			  const userChatId = data.split('_')[1];
			  forwardingSessions[adminChatId] = userChatId;
			  bot.sendMessage(adminChatId, '–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ—Ç–≤–µ—Ç–∞:');
		 }
	} else if (data.startsWith('restore_')) {
		 if (adminId === adminChatId) {
			  const userChatId = data.split('_')[1];
			  forwardingSessions[userChatId] = adminChatId;
			  forwardingSessions[adminChatId] = userChatId;
			  bot.sendMessage(adminChatId, '–ß–∞—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ú–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ.');
			  bot.sendMessage(userChatId, '–ß–∞—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.', {
					reply_markup: {
						 keyboard: [[{ text: '–ü–æ–∫–∏–Ω—É—Ç—å —á–∞—Ç' }]],
						 resize_keyboard: true,
						 one_time_keyboard: true,
					}
			  });
		 }
	}
});

